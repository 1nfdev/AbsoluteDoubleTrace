var Prefs = {
	Defaults:{
		"Pref_WebController":{
			"enabled":true,
			"lastRequest":1551633680,
			"useLocal":{
				"enabled":true
			},
			"showBlocked":{
				"enabled":true
			},
			"tld":{
				"enabled":true,
				"settings":{
					"accountant":false,
					"ads":true,
					"asia":false,
					"bid":true,
					"cc":false,
					"cf":false,
					"christmas":false,
					"click":true,
					"club":true,
					"country":true,
					"cricket":false,
					"date":false,
					"diet":false,
					"download":true,
					"faith":true,
					"gdn":true,
					"gq":true,
					"icu":false,
					"jetzt":true,
					"kim":true,
					"link":true,
					"loan":false,
					"market":true,
					"men":false,
					"mom":false,
					"om":true,
					"online":false,
					"party":false,
					"pro":false,
					"racing":false,
					"ren":false,
					"review":false,
					"science":true,
					"space":true,
					"stream":false,
					"study":false,
					"systems":false,
					"top":true,
					"trade":false,
					"vip":false,
					"wang":true,
					"webcam":true,
					"win":true,
					"work":true,
					"xin":false,
					"yokohama":false,
					"zip":true
				}
			},
			"urlCleaner":{
				"enabled":false,
				"queryString":{
					"enabled":true,
					"params":{
						"ga_source":true,
						"ga_medium":true,
						"ga_term":true,
						"ga_content":true,
						"ga_campaign":true,
						"ga_place":true,
						"utm_source":true,
						"utm_campaign":true,
						"utm_content":true,
						"utm_medium":true,
						"utm_name":true,
						"utm_cid":true,
						"utm_reader":true,
						"utm_term":true,
						"ad_bucket":false,
						"ad_size":false,
						"ad_slot":false,
						"ad_type":false,
						"adid":false,
						"adserverid":false,
						"adserveroptimizerid":false,
						"adtype":false,
						"adurl":false,
						"clickid":false,
						"clkurlenc":false,
						"fb_source":false,
						"fb_ref":false,
						"CampaignID":false,
						"AffiliateGuid":false,
						"AdID":false,
						"ImpressionGuid":false,
						"ga_fc":false,
						"ga_hid":false,
						"ga_sid":false,
						"ga_vid":false,
						"piggiebackcookie":false,
						"pubclick":false,
						"pubid":false,
						"num_ads":false,
						"tracking":false,
						"usegapi":false,
						"affiliate":false,
						"first_visit":false,
						"trackId":false,
						"_trkparms":false,
						"bdref":false,
						"bstk":false,
						"campaignid":false,
						"dclid":false,
						"documentref":false,
						"exitPop":false,
						"flash":false,
						"matchid":false,
						"mediadataid":false,
						"minbid":false,
						"page_referrer":false,
						"referrer":false,
						"reftype":false,
						"revmod":false,
						"rurl":false,
						"siteid":false,
						"tldid":false,
						"zoneid":false,
						"site":false,
						"fb":false,
						"pk_campaign":false,
						"_reqid":false,
						"data":false,
						"payload":false,
						"providerid":false,
						"rev":false,
						"uid":false,
						"sourceid":false,
						"origin":false
					},
					"main_frame":{
						"method":"remove"
					},
					"resources":{
						"method":"remove"
					}
				},
				"fragmentHash":{
					"enabled":false
				}
			},
			"installCodes":{
				"a00000001":false,
				"a00000002":true,
				"a00000003":false,
				"a00000005":true
			}
		},
		"Pref_CanvasFingerprint":{
			"enabled":true,
			"customRGBA":{
				"enabled":false,
				"rgba":[0,0,0,0]
			}
		},
		"Pref_AudioFingerprint":{
			"enabled":false,
			"audioBuffer":{
				"enabled":true
			},
			"audioData":{
				"enabled":true
			},
			"audioOfflineMain":{
				"enabled":false
			},
			"audioMain":{
				"enabled":false
			}
		},
		"Pref_WebGLFingerprint":{
			"enabled":false
		},
		"Pref_NativeFunctions":{
			"enabled":false,
			"windowOpen":{
				"enabled":true
			}
		},
		"Pref_CommonTracking":{
			"enabled":false,
			"settings":{
				"piwik":{
					"enabled":false
				},
				"google":{
					"enabled":true
				},
				"segment":{
					"enabled":false
				},
				"countly":{
					"enabled":false
				},
				"fbevents":{
					"enabled":true
				}
			}
		},
		"Pref_HardwareSpoof":{
			"enabled":true,
			"hardware":{
				"enabled":true,
				"hardwareConcurrency":{
					"enabled":true,
					"value":4
				},
				"deviceMemory":{
					"enabled":true,
					"value":4
				}
			}
		},
		"Pref_CookieEater":{
			"enabled":false,
			"settings":{
				"setcookie":{
					"enabled":true,
					"fp_method":"nothing",
					"fp_level":1,
					"tp_method":"remove",
					"tp_level":1
				},
				"cookie":{
					"enabled":false,
					"fp_method":"nothing",
					"fp_level":1,
					"tp_method":"remove",
					"tp_level":1
				}
			},
			"list":{
				"__mmapiwsid":false,
				"__utmz":false,
				"__utmc":false,
				"__utma":false,
				"__cfduid":false,
				"_chartbeat2":false,
				"_ga":false,
				"_v__chartbeat3":false,
				"_vwo_uuid_v2":false,
				"_vwo_uuid_":false,
				"1P_JAR":false,
				"ads_prefs":false,
				"external_referer":false,
				"GoogleAdServingTest":false,
				"personalization_id":false,
				"S_adsense3-ui":false
			}
		},
		"Pref_ReferHeader":{
			"enabled":false,
			"jsVariable":{
				"enabled":true,
				"method":"remove"
			},
			"httpHeader":{
				"allowSameHost":{
					"enabled":true,
					"fullUrl":true
				},
				"allowSameDomain":{
					"enabled":true,
					"fullUrl":true
				},
				"allowThirdParty":{
					"enabled":false,
					"fullUrl":false
				},
				"onlySecureOrigins":{
					"enabled":true
				}
			}
		},
		"Pref_GoogleHeader":{
			"enabled":false,
			"rmClientData":{
				"enabled":false
			},
			"rmChromeUMA":{
				"enabled":true
			},
			"rmChromeVariations":{
				"enabled":true
			},
			"rmChromeConnected":{
				"enabled":true
			}
		},
		"Pref_ETagTrack":{
			"enabled":false
		},
		"Pref_PingBlock":{
			"enabled":true,
			"removePingAttr":{
				"enabled":false
			},
			"pingRequest":{
				"enabled":true
			},
			"sendBeacon":{
				"enabled":true
			}
		},
		"Pref_NetworkInformation":{
			"enabled":false,
			"customNet":{
				"enabled":false,
				"info":{
					"downlink":7.5,
					"effectiveType":"4g",
					"onchange":null,
					"rtt":100
				}
			}
		},
		"Pref_ScreenRes":{
			"enabled":false,
			"randomOpts":{
				"enabled":true,
				"values":[-50,50]
			},
			"commonResolutions":{
				"enabled":false,
				"resolutions":[]
			},
			"modifyDepths":{
				"enabled":false,
				"values":[16,24,32]
			},
			"modifyPixelRatio":{
				"enabled":false
			}
		},
		"Pref_BatteryApi":{
			"enabled":false
		},
		"Pref_ClientRects":{
			"enabled":false
		},
		"Pref_PluginHide":{
			"enabled":false
		},
		"Pref_UserAgent":{
			"enabled":false,
			"uaOSConfig":{
				"AllowMac":{
					"enabled":false
				},
				"AllowLinux":{
					"enabled":false
				},
				"AllowWindows":{
					"enabled":true
				}
			},
			"uaWBConfig":{
				"AllowChrome":{
					"enabled":true
				},
				"AllowFirefox":{
					"enabled":false
				},
				"AllowVivaldi":{
					"enabled":true
				},
				"AllowOpera":{
					"enabled":true
				},
				"AllowEdge":{
					"enabled":false
				},
				"AllowSafari":{
					"enabled":true
				}
			},
			"uaCust":{
				"enabled":false,
				"onlyCust":false,
				"customUAs":[]
			}
		},
		"Pref_WebRTC":{
			"enabled":true,
			"wrtcInternal":{
				"enabled":true
			},
			"wrtcPeerConnection":{
				"enabled":false
			},
			"wrtcDataChannel":{
				"enabled":false
			},
			"wrtcRtpReceiver":{
				"enabled":false
			}
		},
		"Pref_IPSpoof":{
			"enabled":false,
			"useClientIP":{
				"enabled":true
			},
			"useForwardedFor":{
				"enabled":true
			},
			"traceVia":{
				"enabled":true,
				"value":"Proxy"
			},
			"traceIP":{
				"enabled":true,
				"user_set":""
			}
		},
		"Main_Interface":{
			"enabled":true,
			"Theme":{
				"name":"tracedefault",
				"timeAlterations":true,
				"navPlacement":"nav_left"
			}
		},
		"Main_Trace":{
			"AdvancedUi":{
				"enabled":false
			},
			"DebugApp":{
				"enabled":false
			},
			"DomainCache":{
				"enabled":true
			},
			"ProtectionSessions":{
				"enabled":true,
				"affects":[]
			},
			"ProtectionStats":{
				"enabled":true
			},
			"TabStats":{
				"enabled":true
			},
			"BrowserNotifications":{
				"enabled":false
			},
			"KeyboardCommand":{
				"enabled":false
			},
			"ErrorReporting":{
				"enabled":true
			},
			"PremiumCode":""
		},
		"Main_ExecutionOrder":{
			"AllPage":[
				"Pref_CanvasFingerprint",
				"Pref_AudioFingerprint",
				"Pref_GoogleHeader",
				"Pref_ETagTrack",
				"Pref_PingBlock",
				"Pref_NativeFunctions",
				"Pref_NetworkInformation",
				"Pref_ClientRects",
				"Pref_HardwareSpoof",
				"Pref_ScreenRes",
				"Pref_PluginHide",
				"Pref_WebRTC",
				"Pref_CookieEater",
				"Pref_ReferHeader",
				"Pref_UserAgent",
				"Pref_BatteryApi",
				"Pref_IPSpoof",
				"Pref_WebGLFingerprint"
			],
			"PerPage":[]
		}
	},
	Current:{},
	SetDefaults:function(apply,cb){
		Trace.Notify("Setting new default settings...","prefd");

		Vars.s.set(Prefs.Defaults);

		if (apply && cb){
			Prefs.NewLoad(cb);
		}
	},
	Load:function(cb){
		if (!window.chrome.storage) alert("Trace encountered an error: Couldn't access Storage API.");

		if (Trace.DEBUG) console.info("[prefd]-> Trace[0] is loading your settings.");
		Vars.s.get(["tracenewprefs"],function(s){
			if (typeof s.tracenewprefs !== "boolean"){
				Prefs.SetDefaults(true,cb);
			} else {
				Prefs.NewLoad(cb);
			}
		});
	},
	NewLoad:function(cb){
		if (!window.chrome.storage) alert("Trace encountered an error: Couldn't access Storage API.");

		if (Trace.DEBUG) console.info("[prefd]-> Trace[1] is loading your settings.");
		Vars.s.get(
			[
				"Pref_WebController",
				"Pref_CanvasFingerprint",
				"Pref_AudioFingerprint",
				"Pref_WebGLFingerprint",
				"Pref_HardwareSpoof",
				"Pref_CookieEater",
				"Pref_ReferHeader",
				"Pref_GoogleHeader",
				"Pref_ETagTrack",
				"Pref_PingBlock",
				"Pref_NetworkInformation",
				"Pref_NativeFunctions",
				"Pref_ScreenRes",
				"Pref_BatteryApi",
				"Pref_ClientRects",
				"Pref_PluginHide",
				"Pref_UserAgent",
				"Pref_WebRTC",
				"Pref_IPSpoof",
				"Main_Interface",
				"Main_Trace",
				"Main_ExecutionOrder"
			],
			function(prefs){
				// Check that there are settings
				if (Object.keys(prefs).length === 0){
					Prefs.SetDefaults();
				}

				// Fix broken preferences
				var changes = false;
				for (var k in Prefs.Defaults){
					if (typeof prefs[k] !== typeof Prefs.Defaults[k]){
						prefs[k] = Prefs.Defaults[k];
						changes = true;
						console.log("[PrefRepair]->",k);
					}

					for (var j in Prefs.Defaults[k]){
						if (typeof prefs[k][j] !== typeof Prefs.Defaults[k][j]) {
							prefs[k][j] = Prefs.Defaults[k][j];
							changes = true;
							console.log("[PrefRepair]->", k, j);
						}

						if (typeof Prefs.Defaults[k][j] === "object"){
							for (var i in Prefs.Defaults[k][j]){
								if (k === "Main_ExecutionOrder") continue;

								if (typeof prefs[k][j][i] !== typeof Prefs.Defaults[k][j][i]) {
									prefs[k][j][i] = Prefs.Defaults[k][j][i];
									changes = true;
									console.log("[PrefRepair]->", k, j, i);
								}

								if (typeof Prefs.Defaults[k][j][i] === "object"){
									for (var h in Prefs.Defaults[k][j][i]){
										if (typeof prefs[k][j][i][h] !== typeof Prefs.Defaults[k][j][i][h]) {
											prefs[k][j][i][h] = Prefs.Defaults[k][j][i][h];
											changes = true;
											console.log("[PrefRepair]->", k, j, i, h);
										}
									}
								}
							}
						}
					}
				}

				var currProts = [], defProts = [];
				currProts = currProts.concat(prefs.Main_ExecutionOrder.AllPage,prefs.Main_ExecutionOrder.PerPage);
				defProts = defProts.concat(Prefs.Defaults.Main_ExecutionOrder.AllPage,Prefs.Defaults.Main_ExecutionOrder.PerPage);
				if (currProts.length < defProts.length){
					for (var p = 0;p<defProts.length;p++){
						if (currProts.indexOf(defProts[p]) === -1) {
							console.log("[PrefRepair]-> Fixing Main_ExecutionOrder",defProts[p]);
							prefs.Main_ExecutionOrder.PerPage.push(defProts[p]);
							changes = true;
						}
					}
				}

				if (changes === true){
					console.log("[prefd]-> Preferences repaired and saved.");
					Vars.s.set(prefs);
				}

				if (typeof prefs.Pref_WebController.installCodes.a00000003 === "undefined"){
					if (prefs.Main_Trace.PremiumCode.length > 5) {
						prefs.Pref_WebController.installCodes["a00000003"] = true;
						prefs.Pref_WebController.installCodes["a00000001"] = true;
						console.log("[prefd]-> Fixed premium list");
					}
				}

				// Set settings
				Prefs.Current = prefs;

				// Callback
				cb();
			}
		);
	},
	ToggleSetting:function(setting,cb){
		var data = Prefs.Current;

		if (setting.includes(".")){
			var sett = setting.split(".");
			data[sett[0]][sett[1]]["enabled"] = !Prefs.Current[sett[0]][sett[1]]["enabled"];
		} else {
			data[setting]["enabled"] = !Prefs.Current[setting]["enabled"];
		}

		Vars.s.set(data,function(){
			Prefs.TakeAction(setting,(setting.includes(".") ? Prefs.Current[sett[0]][sett[1]]["enabled"]: data[setting]));
			if (cb) cb();
		});
	},
	GetSetting:function(setting){
		var data = Prefs.Current;
		var sett = setting.split(".");

		if (sett.length === 1) {
			return data[setting];
		} else if (sett.length === 2){
			return data[sett[0]][sett[1]];
		} else if (sett.length === 3) {
			return data[sett[0]][sett[1]][sett[2]];
		} else if (sett.length === 4) {
			return data[sett[0]][sett[1]][sett[2]][sett[3]];
		} else if (sett.length === 5) {
			return data[sett[0]][sett[1]][sett[2]][sett[3]][sett[4]];
		}

		return null;
	},
	SetMultiple:function(settings){
		var keys = Object.keys(settings);
		for (var i = 0, l = keys.length;i<l;i++){
			Prefs.Set(keys[i],settings[keys[i]]);
		}
	},
	Set:function(setting,val){
		var data = Prefs.Current;
		var sett = setting.split(".");
		var deadSafe = JSON.parse(JSON.stringify(val));

		if (sett.length === 1) {
			data[setting] = deadSafe;
		} else if (sett.length === 2){
			data[sett[0]][sett[1]] = deadSafe;
		} else if (sett.length === 3) {
			data[sett[0]][sett[1]][sett[2]] = deadSafe;
		} else if (sett.length === 4) {
			data[sett[0]][sett[1]][sett[2]][sett[3]] = deadSafe;
		} else if (sett.length === 5) {
			data[sett[0]][sett[1]][sett[2]][sett[3]][sett[4]] = deadSafe;
		}

		Vars.s.set(data,function(){
			Prefs.TakeAction(setting,deadSafe);
		});
	},
	TakeAction:function(setting,val){
		if (Trace.DEBUG) console.info("[prefd]-> Updating",setting,"to",val);

		// Toggle debug messages
		if (setting === "Main_Trace.DebugApp"){
			Trace.DEBUG = val;
		}

		// Toggle web-rtc protection
		if (setting === "Pref_WebRTC.wrtcInternal.enabled" || setting === "Pref_WebRTC"){
			Trace.f.ToggleWebRtc();
		}

		// Toggle domain blocking protection
		if (setting === "Pref_WebController" || setting === "Pref_WebController.enabled"){
			if (val.enabled){
				Web.BlocklistLoader(false);
				WebBlocker.AssignChecker();
			} else {
				WebBlocker.RemoveChecker();
			}
		}

		// Toggle Coookie Eater protection
		if (setting === "Pref_CookieEater"){
			if (val.enabled){
				Headers.Cookie.Start();
			} else {
				Headers.Cookie.Stop();
			}
		}

		// Toggle E-Tag protection
		if (setting === "Pref_ETagTrack"){
			if (val.enabled){
				Headers.Etag.Start();
			} else {
				Headers.Etag.Stop();
			}
		}

		// Toggle Google Header overall protection
		if (setting === "Pref_GoogleHeader"){
			if (val.enabled){
				Headers.Google.Start();
			} else {
				Headers.Google.Stop();
			}
		}

		// Toggle Google Header overall protection
		if (setting === "Pref_ReferHeader"){
			if (val.enabled){
				Headers.Referer.Start();
			} else {
				Headers.Referer.Stop();
			}
		}

		// Toggle user-agent randomiser background task
		if (setting === "Pref_UserAgent"){
			Trace.f.ToggleUserAgentRandomiser(false);
			if (val.enabled){
				Headers.UserAgent.Start();
			} else {
				Headers.UserAgent.Stop();
			}
		}

		// Toggle user-agent randomiser background task
		if (setting === "Pref_WebGLFingerprint"){
			Trace.f.ToggleGPURandomiser(false);
		}

		if (setting === "Pref_PingBlock.pingRequest.enabled" || setting === "Pref_PingBlock"){
			Web.ToggleBlockPings();
		}

		// Load IPSpoof settings
		if (setting.includes("Pref_IPSpoof")){
			Trace.i.ToggleIPSpoof(false);
		}

		// Load BadTLD settings
		if (setting === "Pref_WebController.tld" || setting === "Pref_WebController.tld.level"){
			Trace.g.BadTopLevelDomain.ToggleProtection();
		}

		// Toggle error reporting
		if (setting === "Main_Trace.ErrorReporting"){
			Vars.eReporting = val;
		}

		// Toggle browser notifications
		if (setting === "Main_Trace.BrowserNotifications"){
			Vars.bNotifications = val;
		}

		// Update current premium code
		if (setting === "Main_Trace.PremiumCode"){
			Vars.Premium = val;
		}
	},
	CreateBackup:function(cb){
		Vars.s.get(null, function(items) {
			var backupObj = {
				"compat":1,
				"maxStoreSize":Vars.s.QUOTA_BYTES || 0,
				"backupTime":(new Date).toString(),
				"version":chrome.runtime.getManifest().version || null,
				"browser":navigator.userAgent || "Unknown.",
				"computed":{
					"verified":null
				},
				"data":{}
			};
			var k = Object.keys(items);
			for (var i = 0, l = k.length;i<l;i++){
				//if (k[i].substr(0,4) === "Pref" || k[i].substr(0,4) === "Main" || k[i].substr(0,4) === "stats"){
				if (k[i].substr(0,4) !== "WebC") {
					backupObj["data"][k[i]] = items[k[i]];
				} //}
			}

			try{
				backupObj["computed"]["verified"] = MD5(JSON.stringify(backupObj["data"],null,2));
			} catch(e){
				_UserCrashReportService(e);
			}

			cb(backupObj);
		});
	},
	EchoStorage:function(){
		Vars.s.get(null, function(items) {
			console.log(items);
		});
	},
	ClearStorage:function(){
		chrome.storage.local.clear(function() {
			var error = chrome.runtime.lastError;
			if (error) {
				console.error(error);
			}
		});
	}
};